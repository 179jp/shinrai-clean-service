---
// Components
import Layout from '../layouts/Layout.astro';
import SeasonalContent from '../components/SeasonalContent.astro';
import ServiceCard from '../components/ServiceCard.astro';

// Content
import { serviceSections } from '../content/serviceSections';
import { notes, priceDate } from '../content/notes';
import { company } from '../content/company';

// Styles
import '../styles/index.css';

const standardSections = serviceSections.filter(
  (section) => section.group !== 'special'
);
const specialSections = serviceSections.filter(
  (section) => section.group === 'special'
);

const requestOptions = Array.from(
  new Set(
    serviceSections.flatMap((section) => {
      if ('items' in section) {
        return section.items.map((item) => `${section.label} - ${item.name}`);
      }
      if ('rows' in section) {
        return section.rows.map((row) => `${section.label} - ${row.set}`);
      }
      return [];
    })
  )
);

const timeSlots = [
  '09:00',
  '10:00',
  '11:00',
  '12:00',
  '13:00',
  '14:00',
  '15:00',
  '16:00',
  '17:00',
  '18:00',
];
---

<Layout>
  <div class="page">
    <header class="hero">
      <p class="logo">
        <img
          src="/img/logo.svg"
          alt="SHINRAI CLEAN SERVICE"
          width="200"
          height="72"
        />
      </p>
      <div class="hero__copy">
        <h1 class="eyebrow">
          <span class="color-primary">SHINRAI</span> CLEAN SERVICE
        </h1>
        <h2 class="hero__title">
          汚れ<span>の</span>天敵<br />
          カビ<span>の</span>刺客
        </h2>
      </div>
      <div class="hero__lead -vt">
        <p>
          見えるところはもちろん、<br />
          見えないところも<br />
          根本からきれいにする。
        </p>
        <p>
          汚れの特性を見極めた<br />
          洗剤・溶剤・掃除用具。
        </p>
        <p>
          住まいの空気を変える、<br />
          プロのクリーニング。
        </p>
      </div>
    </header>

    <div class="contact-overlay" id="contactOverlay" aria-hidden="true">
      <div
        class="contact-drawer"
        id="contactDrawerPanel"
        role="dialog"
        aria-modal="true"
        aria-label="お問い合わせフォーム"
        tabindex="-1"
      >
        <div class="contact-drawer__header">
          <div>
            <p class="eyebrow">Contact</p>
            <h3 class="contact-drawer__title">お見積り・ご依頼フォーム</h3>
          </div>
          <button
            type="button"
            class="contact-drawer__close"
            id="contactDrawerClose"
            aria-label="フォームを閉じる"
          >
            ×
          </button>
        </div>

        <form
          class="contact-form"
          name="contact"
          method="POST"
          data-netlify="true"
          data-netlify-honeypot="bot-field"
        >
          <input type="hidden" name="form-name" value="contact" />
          <p class="visually-hidden">
            <label>
              送信しないでください
              <input name="bot-field" />
            </label>
          </p>

          <label class="form-field">
            <span class="form-label">ご依頼（複数選択可）</span>
            <select name="ご依頼" id="request" multiple required>
              {requestOptions.map((option) => <option>{option}</option>)}
            </select>
            <small class="form-help">※ ⌘/Ctrl キーで複数選択できます</small>
          </label>

          <fieldset class="form-field">
            <legend class="form-label">ご希望の日時</legend>
            <div class="datetime-preferences">
              {[1, 2, 3].map((index) => (
                <div class="datetime-preference">
                  <div class="datetime-preference__title">
                    <span>第{index}希望</span>
                    {index === 1 ? (
                      <span class="required-badge">必須</span>
                    ) : (
                      <span class="optional">任意</span>
                    )}
                  </div>
                  <div class="datetime-preference__fields">
                    <label class="form-subfield">
                      <span>日付</span>
                      <input
                        type="date"
                        name={`希望日_${index}`}
                        required={index === 1}
                      />
                    </label>
                    <label class="form-subfield">
                      <span>時間</span>
                      <div class="time-range">
                        <select
                          name={`開始時間_${index}`}
                          required={index === 1}
                        >
                          {timeSlots.map((slot) => (
                            <option value={slot}>{slot}</option>
                          ))}
                        </select>
                        <span class="time-separator">〜</span>
                        <select
                          name={`終了時間_${index}`}
                          required={index === 1}
                        >
                          {timeSlots.map((slot) => (
                            <option value={slot}>{slot}</option>
                          ))}
                        </select>
                      </div>
                    </label>
                  </div>
                </div>
              ))}
            </div>
          </fieldset>

          <label class="form-field">
            <span class="form-label">お名前</span>
            <input type="text" name="お名前" placeholder="山田 太郎" required />
          </label>

          <label class="form-field">
            <span class="form-label">電話番号</span>
            <input type="tel" name="電話番号" placeholder="090-1234-5678" required />
          </label>

          <label class="form-field">
            <span class="form-label">TEL</span>
            <input type="tel" name="TEL" placeholder="固定電話など" />
          </label>

          <label class="form-field">
            <span class="form-label">コメント</span>
            <textarea
              name="コメント"
              rows="4"
              placeholder="ご要望やご相談内容をご記入ください"
            ></textarea>
          </label>

          <button type="submit" class="contact-submit">送信する</button>
        </form>
      </div>
    </div>

    <section class="section" id="services">
      <div class="section__header">
        <p class="eyebrow">Service & Pricing</p>
        <h2>サービス & 料金表</h2>
        <p class="service-timestamp">{priceDate}現在</p>
      </div>

      <div class="service-tabs" id="serviceTabs">
        {
          standardSections.map((section) => (
            <button class="service-tab" type="button" data-target={section.id}>
              {section.label}
            </button>
          ))
        }
      </div>

      <div class="service-slider" id="serviceSlider">
        {standardSections.map((section) => <ServiceCard section={section} />)}
      </div>

      <div class="service-special">
        {specialSections.map((section) => <ServiceCard section={section} />)}
      </div>

      <ul class="notes">
        {notes.map((note) => <li>{note}</li>)}
      </ul>
    </section>

    <section class="section" id="seasonal">
      <div class="section__header">
        <p class="eyebrow">Seasonal Recommend</p>
        <h2>季節のおすすめ</h2>
      </div>
      <SeasonalContent />
    </section>

    <section class="section" id="company">
      <div class="section__header">
        <p class="eyebrow">Company</p>
        <h2>会社情報</h2>
      </div>
      <dl class="panel company">
        <div class="company__row">
          <dt>会社名</dt>
          <dd>{company.name}</dd>
        </div>
        <div class="company__row">
          <dt>代表</dt>
          <dd>{company.representative}</dd>
        </div>
        <div class="company__row">
          <dt>住所</dt>
          <dd>{company.address}</dd>
        </div>
        <div class="company__row">
          <dt>電話</dt>
          <dd>{company.phone}</dd>
        </div>
        <div class="company__row">
          <dt>メール</dt>
          <dd><a href={`mailto:${company.email}`}>{company.email}</a></dd>
        </div>
        <div class="company__row company__row--icon">
          <a
            class="company__link"
            href={company.instagram}
            target="_blank"
            rel="noreferrer"
          >
            <svg aria-hidden="true" viewBox="0 0 24 24" class="icon">
              <path
                d="M7 3h10a4 4 0 0 1 4 4v10a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V7a4 4 0 0 1 4-4Zm0 2a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H7Zm11.25 1.5a1.25 1.25 0 1 1-2.5 0a1.25 1.25 0 0 1 2.5 0ZM12 8.5A3.5 3.5 0 1 1 8.5 12A3.5 3.5 0 0 1 12 8.5Zm0 2a1.5 1.5 0 1 0 1.5 1.5A1.5 1.5 0 0 0 12 10.5Z"
              ></path>
            </svg>
          </a>
        </div>
      </dl>
    </section>
    <footer>
      <ul class="footer-links">
        <li>
          <button type="button" data-contact-trigger>
            汚れ<span>の</span>天敵<span>を</span>呼ぶ
          </button>
        </li>
        <li>
          <button type="button" data-contact-trigger>
            カビ<span>の</span>刺客<span>を</span>呼ぶ
          </button>
        </li>
      </ul>
    </footer>
  </div>
</Layout>

<script>
  const slider = document.getElementById('serviceSlider');
  const tabs = Array.from(document.querySelectorAll('[data-target]'));
  const cards = Array.from(slider?.querySelectorAll('.service-card') ?? []);

  const setActive = (id) => {
    tabs.forEach((tab) => {
      tab.classList.toggle('is-active', tab.dataset.target === id);
    });
  };

  const scrollToCard = (targetId) => {
    const target = cards.find((card) => card.id === targetId);
    target?.scrollIntoView({
      behavior: 'smooth',
      inline: 'center',
      block: 'nearest',
    });
  };

  tabs.forEach((tab) => {
    tab.addEventListener('click', () => {
      const targetId = tab.dataset.target;
      if (!targetId) return;
      scrollToCard(targetId);
      setActive(targetId);
    });
  });

  const updateActiveFromScroll = () => {
    if (!slider) return;
    const sliderRect = slider.getBoundingClientRect();
    let closestId;
    let smallestOffset = Number.POSITIVE_INFINITY;

    cards.forEach((card) => {
      const rect = card.getBoundingClientRect();
      const offset = Math.abs(rect.left - sliderRect.left);
      if (offset < smallestOffset) {
        smallestOffset = offset;
        closestId = card.id;
      }
    });

    setActive(closestId);
  };

  slider?.addEventListener('scroll', () => {
    requestAnimationFrame(updateActiveFromScroll);
  });

  updateActiveFromScroll();

  const contactOverlay = document.getElementById('contactOverlay');
  const contactDrawer = document.getElementById('contactDrawerPanel');
  const contactCloseButton = document.getElementById('contactDrawerClose');
  const contactTriggers = Array.from(
    document.querySelectorAll('[data-contact-trigger]')
  );
  let lastActiveElement;

  const closeContactDrawer = () => {
    contactOverlay?.classList.remove('is-open');
    contactOverlay?.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('no-scroll');
    if (lastActiveElement instanceof HTMLElement) {
      lastActiveElement.focus();
    }
  };

  const openContactDrawer = () => {
    lastActiveElement = document.activeElement;
    contactOverlay?.classList.add('is-open');
    contactOverlay?.setAttribute('aria-hidden', 'false');
    document.body.classList.add('no-scroll');
    contactDrawer?.focus();
  };

  contactTriggers.forEach((trigger) => {
    trigger.addEventListener('click', (event) => {
      event.preventDefault();
      openContactDrawer();
    });
  });

  contactCloseButton?.addEventListener('click', () => {
    closeContactDrawer();
  });

  contactOverlay?.addEventListener('click', (event) => {
    if (event.target === contactOverlay) {
      closeContactDrawer();
    }
  });

  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
      closeContactDrawer();
    }
  });
</script>
